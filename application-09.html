<html>
    <head>
        <title>New Adobe AIR Project</title>
        <script type="text/javascript" src="lib/air/AIRAliases.js"></script>
        <script type="text/javascript" src="lib/air/AIRIntrospector.js"></script>
        <script type="text/javascript" src="lib/air/AIRSourceViewer.js"></script>
		<script type="application/x-shockwave-flash" src="lib/as3corelib.swf"></script>
	        
		<script type="text/javascript" src="lib/jquery/jquery-1.4.2.big.js"></script>
		<script type="text/javascript" src="js/jquery.air.js"></script> 
    </head>
    <body>
    		
		<script type="text/javascript">
			$(function() {  
				var shell = $.air({
					db: { key: "bbs2" },
					models: {
						contact: {
							id: { type: "integer", primaryKey: true, autoIncrement: true },
							firstName: { type: "varchar", size: 32 },
							lastName: { type: "varchar", size: 32 },
							phone: { type: "varchar", size: 32 },
							email: { type: "varchar", size: 64 }, 
							website: { type: "varchar", size: 256 },
							birthDate: { type: "varchar", size: 32 },
							notes: { type: "varchar" },
							photo: { type: "blob" },
							toString: function() { return this.firstName + " " + this.lastName; },
							toHTML: function() { 
								return "<table><tr>" + 
											"<td><img id='img_" + this.id  + "' width=36 height=48 class='photoSmall' src='" + "" + "' /></td>" +
											"<td><span class='tableFieldName listValue'>" + this.firstName + " " + this.lastName + "</span><span class='tableFieldName listValue'>" + this.phone + "</span></td>" +
										"</tr></table>";
							}
						}
					}, 
					services: {
						contact: {
							get: function(criteria) {
								
							},
							save: function(contact) {
								
							},
							del: function(id) {
								
							}
						}
					},
					views: {
						login: { 
							path: "/view/test/blackbooksafe/login.html",
							position: { x: 70, y: 20 } 
						},
						newUser: {
							path: "/view/test/blackbooksafe/new-user.html",
							position: { x: 70, y: 20 }
						},
						list: {
							path: "/view/test/blackbooksafe/list.html",
							position: { x: 70, y: 20 }
						},
						detail: {
							path: "/view/test/blackbooksafe/detail.html",
							position: { x: 120, y: 70 }
						}, 
						edit: {
							path: "/view/test/blackbooksafe/edit.html",
							position: { x: 120, y: 70 }
						},
						confirmDelete: {
							path: "/view/test/blackbooksafe/confirm-delete.html",
							position: { x: 120, y: 70 }
						},
						about: {
							path: "/view/test/blackbooksafe/about.html",
							position: { x: 91.5, y: 144 }
						}
					},
					presenters: { 
						login: {
							view: {
								elements: 
							},
							submit: function() {
								//todo: login stuff from below
								this.trigger("loggedIn");
							},
							events: {
								keydown: {
									enter: function() { this.submit(); },
									numpad_enter: function() { this.submit(); }
								}, 
								click: {
									closelogin: function() { this.exit(); }, 
									oklogin: function() { this.submit(); }
								}
							}
						},
						newUser: {
							view: {},
							submit: function() {
								//todo: newuser / login stuff
								this.trigger("loggedIn");
							},
							events: {
								keydown: {
									enter: function() { this.submit(); },
									numpad_enter: function() { this.submit(); }
								}, 
								click: {
									okcreatepass: function() { this.submit(); }
								}
							}
						},
						list: { 
							view: {
								elements: {
									list: function() { return this.get("list"); },
									listBorder: function() { return this.get("listPageBorder"); }
								},
								widgets: {
									list: function() { return new $.air.ui.List(this.elements("list"), {}); }
								}
							},
							build: function(props) {
								//async service call to build list
								
								var list = this.view.widgets("list");
								list.bind(this.shell.services("contact").get());
								
								if(props && props.id) { 
									//select item in list 
									list.select(props.id);
								}
							},
							add: function() { this.trigger("addContact"); },
							detail: function() {
								//todo: get selected record from view list
								var id = 3;
								this.trigger("displayContact", {id: id});
							}, 
							next: function() {
								//todo: set next selected record on view list
							},
							prev: function() {
								//todo: set prev selected record on view list
							},
							about: function() { this.trigger("displayAbout"); },
							events: { 
								keydown: {  
									escape: function() { this.exit(); }, 
									enter: function(){ this.detail(); },
									down: function(){ this.next(); }, 
									up: function(){ this.prev(); }
								},
								click: { 
									close: function(){ this.exit(); }, 
									minimize: function(){ this.minimize(); }, 
									viewAbout_btn: function(){ this.about(); }, 
									add: function(){ this.add(); }
								}
							}
						},
						detail: { 
							view: {
							},
							build: function(props) {
								function onSuccess() {
									
								}
								function onFailure() {
									
								}
								
								if(props && props.id) { 
									//get record 
								} else {
									
								}
							},
							events: {
								keydown: {
									escape: function() { this.close(); },
									left: function() { this.prev(); },
									right: function() { this.next(); },
									up: function() { this.edit(); },
									down: function() { this.edit(); },
									del: function() { this.del(); }
								}, 
								click: {
									closedetails : function() { this.close(); }, 
									prevdetails: function() { this.prev(); },
									nextdetails: function() { this.next(); },
									backdetails: function() { this.close(); }, 
									editdetails: function() { this.edit(); }, 
									deletedetails: function() { this.del(); }
								}, 
							}
						}, 
						edit: {
							view: {
								getFirstName: function() { return this.get("editFirstName"); }
							},
							build: function(props) {
								function setForm(item) {
									//form binding
									//manual setting  
								}
								function setFocus() { $(this.view.getFirstName()).focus(); }
								
								if(props && props.id) {
									this.shell.models("contact").get(props, 
										function(result) { 
											setForm.call(this, result);
											setFocus.call(this);
										},
										function() { alert("error!"); }
									); 
								} else { 
									setForm.call(this, this.shell.models("contact").build({}));
									setFocus.call(this);
								} 
							},
							close: function() {
								this.trigger("editContactCanceled");
							},
							submit: function() {
								//save contact
								this.shell.models("contact").save(this.item, 
									function() {
										this.trigger("contactUpdated");
									}, 
									function() { 
										alert("error saving contact");
									}
								);
							},
							events: {
								keydown: {
									escape: function() { this.close(); },
									enter: function() { this.submit(); },
									numpad_enter: function() { this.submit(); }
								}, 
								click: {
									closeedit : function() { this.close(); }, 
									canceledit: function() { this.close(); },
									okedit: function() { this.submit(); }
								} 
							}
						},
						confirmDelete: { 
							view: {
								getConfirmationText: function() { return this.get("confirmText"); } 
							},
							build: function(props) {
								this.item = props.item;
								$(this.view.getConfirmationText()).html(
									"Are you sure you want to remove "
									+ this.item.toString() +
									" from your contact list?"
								);
							},
							close: function() {
								this.trigger("deleteCanceled");
							},
							submit: function() {
								this.shell.models("contact").del(this.item, 
									function() {
										this.trigger("contactDeleted");
									}, 
									function() { 
										alert("error deleting contact");
									}
								);
							},
							events: {
								keydown: {
									escape: function() { this.close(); },
									enter: function() { this.submit(); },
									numpad_enter: function() { this.submit(); }
								}, 
								click: {
									cancelconfirm: function() { this.close(); },
									okconfirm: function() { this.submit(); }
								}
							}
						},
						about: {  
							close: function() { this.trigger("aboutCanceled"); }, 
							events: {
								keydown: {
									escape: function() { this.close(); },
									enter: function() { this.close(); },
									numpad_enter: function() { this.close(); }
								}, 
								click: {
									closeabout: function() { this.close(); }, 
									okabout: function() { this.close(); }
								} 
							}
						}
					}, 
					shell: { 
						list: function() { 
							this.show(this.presenters("list").build());
						},
						detail: function(id) { 
							this.show(this.presenters("detail").build({ id: id}));
						},
						edit: function(id) {
							this.show(this.presenters("edit").build({id: id}));
						},
						about: function() {
							this.show(this.presenters("about").build());
						},
						events: { 
							displayContact: function(args) { this.detail(args.id); },
							displayContactCanceled: function(args) { this.list(); },  
							addContact: function(args) { this.edit(); },
							editContact: function(args) { this.edit(args.id); },
							editContactCanceled: function(args) { if(args.id) { this.detail(args.id); } else { this.list(); } },
							deleteContactCanceled: function(args) { this.list(); }, 
							contactUpdated: function(args) { this.detail(args.id); },
							contactDeleted: function(args) { this.list(); },  
							displayAbout: function(args) { this.about(); },
							aboutCanceled: function(args) { this.list(); }
						}
					},
					transitions: {
						login: {  
							list: function() { 
								//this should be default transition
								this.from.hide();
								this.to.show();
							}
						},
						newUser: {
							list: function() {
								this.from.hide();
								this.to.show();
							}
						},
						list: { 
							detail: function() { 
								this.from.blenderHide(); 
								this.to.zoomShow($.air.bounds.get(this.from.get("listPageBorder")));
							}, 
							edit: function() {  
								this.from.blenderHide();

								var bounds = $.air.bounds.get(this.from.get("listPageBorder"));
								air.trace("bounds: " + bounds);
								this.to.zoomShow(bounds); 
							}, 
							about: function() {
								this.to.show();
							}
						},
						detail: { 
							list: function(args) {   
								//todo: move to presenter
								if(args) {
									if (args.deleted) {
										this.from.blenderDissolve();
									}
								}
							
								var bounds = $.air.bounds.get(this.to.get("listPageBorder")); 
								this.from.zoomHide(bounds);
								
								this.to.blenderShow();
							},
							detail: function(args) {  
								//todo: move this directly into presenter
								this.from.flipY(args.reverse);
							}, 
							edit: function() {
								this.from.flipX(this.to, false);
							},
							confirmDelete: function() { 
								//todo: change this to general method
								var stage = htmlLoader.stage;
								stage.setChildIndex(this.to.htmlLoader, stage.numChildren-1);
								
								this.to.show();
							}
						}, 
						edit: {
							list: function() { 
								this.from.zoomHide($.air.bounds.get(this.to.get("listPageBorder"))); 
								this.to.blenderShow();
							},
							detail: function() { 
								this.to.flipX(this.from, true);
							}
						},
						confirmDelete: {  
							detail: function(args){ 
								if(!args.confirmed) {
									this.from.hide();
									return;	
								}
								
								var current = this.app.data("current");
								if(!current) return;

								var model = this.app.models("contact"), 
									parms = { id: current.id }; 
								//read form - set model properties 
								function onDel(e, result) { 
									$(model).unbind("success", $.proxy(onDel, this));
									
									var list = this.app.data("list");
									list.remove(list.selectedIndex); 
									this.app.removedata("current");

									this.from.hide();
									this.to.to("list", { deleted: true }); 
								}
								
								function onError(e, text) { 
									$(model).unbind("success", $.proxy(onError, this));
									
									air.trace("model del error");
								}
								
								$(model)
								.bind("success", $.proxy(onDel, this))
								.bind("error", $.proxy(onError, this))
								.get(0).del(parms);  
							}
						},
						about: { 
							list: function(){
								this.from.hide();
							}
						}
					}
				});			
			});
		</script>
    </body>
</html>
