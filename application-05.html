<html>
    <head>
        <title>New Adobe AIR Project</title>
        <script type="text/javascript" src="lib/air/AIRAliases.js"></script>
        <script type="text/javascript" src="lib/air/AIRIntrospector.js"></script>
        <script type="text/javascript" src="lib/air/AIRSourceViewer.js"></script>
		<script type="application/x-shockwave-flash" src="lib/as3corelib.swf"></script>
	        
		<script type="text/javascript" src="lib/jquery/jquery-1.4.2.big.js"></script>
		<script type="text/javascript" src="js/jquery.air.js"></script> 
    </head>
    <body>
    		
		<script type="text/javascript">
			$(function() {  
				var app = $.air({ 
					key: "bbs2", 
					models: {
						contact: { 
							id: { type: "integer", primaryKey: true, autoIncrement: true },
							firstName: { type: "varchar", size: 32 },
							lastName: { type: "varchar", size: 32 },
							phone: { type: "varchar", size: 32 },
							email: { type: "varchar", size: 64 }, 
							website: { type: "varchar", size: 256 },
							birthDate: { type: "varchar", size: 32 },
							notes: { type: "varchar" },
							photo: { type: "blob" },
							toString: function() { return this.firstName + " " + this.lastName; },
							toHTML: function() { 
								return "<table><tr>" + 
											"<td><img id='img_" + this.id  + "' width=36 height=48 class='photoSmall' src='" + "" + "' /></td>" +
											"<td><span class='tableFieldName listValue'>" + this.firstName + " " + this.lastName + "</span><span class='tableFieldName listValue'>" + this.phone + "</span></td>" +
										"</tr></table>";
							}
						}  
					}, 
					views: { 
						login: { 
							path: "/view/test/blackbooksafe/login.html",
							htmlLoader: { x: 70, y: 20 }, 
							transitions: { 
								list: function() { 
									this.from.hide(); 

									var model = this.app.models("contact");
									function onSuccess(e, result) {  					
										$(model).unbind("success", $.proxy(onSuccess, this));
										
										air.trace("about to populate list here....");  
										var list = {  
											index: 0, 
											items: [],
											remove: function(index) { 
												if(this.index === index) { this.index = 0; }
												
												this.items.splice(index, 1);
											} ,
											get: function(index) {
												this.index = index;
												return this.items[this.index];
											}, 
											pop: function() { return this.items.pop(); },
											push: function(item) { 
												if(!item) return;
												this.items.push(item);
											}, 
											prev: function() {
												if(this.index === 0) return;
												
												this.index = this.index - 1;
												return this.items[this.index];
											}, 
											next: function() {
												air.trace("nexting");
												air.trace(this.items);
												if(this.items) { air.trace(this.items.length); }
												if(this.index === (this.items.length - 1)) return;
												
												this.index = this.index + 1;
												return this.items[this.index];
											}, 
											find: function(parms) { 
												for(var i = 0, len = this.items.length; i < len; i++) {
													var item = this.items[i];
													var found = true;
													for(var key in parms) {  
														if(item[key] !== parms[key]) { 
															found = false;
															break;
														}
													}
													
													if(found) return item; 
												} 
											},
											sort: function(comparer) {
												this.items.sort(comparer);
												this.index = 0;
											}
										};
										list.index = 0;
										list.items = result.data;
										this.app.data("list", list);

										air.trace("list stuff");
										air.trace(this.app.data("list").items); 
										
										this.to.widgets("list").populate(this.app.data("list").items);   
										this.to.show(); 
										
										
									};
									function onError(e, error) { 
										$(model).unbind("error", $.proxy(onError, this));
									 	air.trace("modelllll gettt errror");  
									};
									
									air.trace("trying to get all contacts");
									$(model)
									.bind("success", $.proxy(onSuccess, this))
									.bind("error", $.proxy(onError, this))
									.get(0).get({});
								}
							}, 
							actions: { 
								keydown: function(event) { 
									var keyCode = event.keyCode;
									switch(keyCode) { 
										case air.Keyboard.ENTER:
										case air.Keyboard.NUMPAD_ENTER:   
										this.submit(); 
										event.stopPropagation();
										break;
									}
								}, 
								click: { 
									closelogin: function() { alert("login close!"); }, 
									oklogin: function() { this.submit(); }
								}
							},
							submit: function() { 
								var pwd = $.trim($(this.get("password")).val()); 
								var db = this.app.db;
								
								air.trace("submitting");
								function onOpen() { 
									air.trace("db opened"); 
									
									this.to("list"); 
									
									//$(db).unbind("open", $.proxy(onOpen, this));
								};
								function onError() { 
									air.trace("db error"); 
									$(this.get("err")).html("Password incorrect.").show();  
									
									//$(db).unbind("error", $.proxy(onError, this));
								};
								
								$(db)
								.bind("open", $.proxy(onOpen, this))
								.bind("error", $.proxy(onError, this))
								.get(0).open(pwd);
							}
						}, 
						newUser: { 
							path: "/view/test/blackbooksafe/new-user.html",
							htmlLoader: { x: 70, y: 20 }, 
							transitions: { 
								list: function() { 
									this.from.hide();
									
									var model = this.app.models("contact");
									function onSuccess(e, result) {  
										$(model).unbind("success", $.proxy(onSuccess, this));
										
										this.app.data("list", {});
										this.to.show(); 
									};
									function onError(e, error) { 
										$(model).unbind("error", $.proxy(onError, this));
										
									 	air.trace("modelllll gettt errror");
										air.trace(error);
										air.trace(error.message); 
									};
									
									air.trace("trying to get all contacts");
									$(model)
									.bind("success", $.proxy(onSuccess, this))
									.bind("error", $.proxy(onError, this))
									.get(0).get({});
								}
							}, 
							actions: { 
								keydown: function(event) { 
									var keyCode = event.keyCode;
									switch(keyCode) { 
										case air.Keyboard.ENTER:
										case air.Keyboard.NUMPAD_ENTER:  
										
										this.submit(); 
										event.stopPropagation();
										break;
									}
								}, 
								click: {
									okcreatepass: function() { this.submit(); }
								}
							}, 
							submit: function() {   
								var newPwd = $.trim($(this.get("new_password")).val()),
									confirmPwd = $.trim($(this.get("confirm_password")).val());
								
								if(newPwd === "" || confirmPwd == "") {
									$(this.get("error")).html("Password fields required").show();
								} else if (newPwd !== confirmPwd) {
									$(this.get("error")).html("Password fields must match").show();
								} else {
									
									var db = this.app.db;
									function onOpen(e, result){
										var contactModel = this.app.models("contact"), contact = contactModel.build({
											firstName: "Ben",
											lastName: "Barrett",
											phone: "630-272-0435",
											email: "benpbarrett@gmail.com",
											notes: "Sample Data"
										});
										
										contact.save();
										this.to("list");
									};
									function onError(e, error){
										$(this.get("error")).html("Password incorrect").show();
									};
									
									$(db)
									.bind("open", $.proxy(onOpen, this))
									.bind("error", $.proxy(onError, this))
									.get(0).open(newPwd); 
								}
							}
						}, 
						list: { 
							path: "/view/test/blackbooksafe/list.html", 
							htmlLoader: { x: 70, y: 20 }, 
							widgets: { 
								list: { 
									id: "listPageBorder", 
									actions: {
										click: function() { 
											air.trace("list clickkkkkkkkk!");
											this.view.detail();
										}
									}
								}
							}, 
							transitions: { 
								detail: function() {
									var current = this.app.data("current");
									air.trace("list to deets"); air.trace(current);
									if(!current) { return; }
									
									this.from.blenderHide();

									this.to.widgets("form").populate(current); 
									this.to.zoomShow($.air.bounds.get(this.from.get("listPageBorder")));
								}, 
								edit: function() {  
									var bounds = $.air.bounds.get(this.from.get("listPageBorder"));
									this.from.blenderHide();

									var current = this.app.data("current"), 
										obj = current || this.app.models("contact").build();
										
									this.to.widgets("form").populate(obj);
									
									air.trace("bounds: " + bounds);
									this.to.zoomShow(bounds);
									$(this.to.get("editPageBorder")).scrollTop(0);
									
									air.trace($(this.to.get("firstName")).focus);
									$(this.to.get("firstName")).focus(); 
								}, 
								about: function() {
									this.to.show();
								}
							}, 
							actions: {
								keydown: function(event) { 
									var keyCode = event.keyCode;
									air.trace("keydown: " + keyCode);
									switch(keyCode) { 
										case air.Keyboard.DOWN:
											this.next();
											event.stopPropagation();
											break;
										case air.Keyboard.UP:
											this.prev();
											event.stopPropagation();
											break;
										case air.Keyboard.ENTER:
											this.detail();
											event.stopPropagation();
											break;
										case air.Keyboard.ESCAPE:
											this.exit();
											event.stopPropagation();
											break;
										default:
											// other keys will just focus the search box
											this.search();
											break;
									}
								}, 
								click: {  
									close : function() { this.exit(); },
									minimize: function() { this.minimize(); },  
									viewAbout_btn: function() { this.about(); }, 
									add: function() { this.add(); }
								}
							},  
							exit: function() { 
								this.app.exit(); 
							}, 
							minimize: function() {
								this.app.minimize();
							},
							about: function() { 
								this.to("about");
							}, 
							add: function() {
								this.to("edit");
							}, 
							prev: function() { 
								var prevRecord = this.app.data("list").prev();
								if(!prevRecord) { return; }
								
								//this.app.controllers("list").
								this.app.data("current", prevRecord); 
								this.app.views("list").widgets("list").select(prevRecord.id); 
							}, 
							next: function() { 
								var nextRecord = this.app.data("list").next();
								if(!nextRecord) { return; }  
								
								this.app.data("current", nextRecord);
								this.app.views("list").widgets("list").select(nextRecord.id);  
							}, 
							detail: function() { 
								var list = this.widgets("list"), 
									current = this.app.data("list").find({ id: list.selectedId });
								
								this.app.data("current", current);
								
								this.widgets("list").select(current.id);
								
								this.to("detail");
							}, 
							search: function() {
								$(this.get("searchBox")).focus();
							}
						}, 
						detail: { 
							path: "/view/test/blackbooksafe/detail.html",
							htmlLoader: { x: 120, y: 70 }, 
							widgets: { 
								form: { id: "form" }
							}, 
							transitions: {  
								list: function(args) {   
									if(args) {
										if (args.deleted) {
											this.from.blenderDissolve();
										}
									}
								
									var bounds = $.air.bounds.get(this.to.get("listPageBorder"));
									var current = this.app.data("current");
									if(current) { 
										air.trace("something..." + current.id); 
										bounds = $.air.bounds.get(this.to.widgets("list").item(current.id)); 
									}
									
									this.from.zoomHide(bounds);
									
									this.to.blenderShow();
								},
								detail: function(args) { 
									var current = this.app.data("current");
									if(!current) { return; }
									
									this.to.widgets("form").populate(current);
									
									air.trace("flipping");
									air.trace("reverse: " + args.reverse);
									this.from.flipY(args.reverse);
								}, 
								edit: function() { 
									var current = this.app.data("current");
									if(!current) { return; }
									
									this.to.widgets("form").populate(current);
									$(this.to.get("editPageBorder")).scrollTop(0);
									$(this.to.get("firstName")).focus();
									
									alert(current.id);
									
									this.from.flipX(this.to, false);
								},
								confirmDelete: function() {
									var current = this.app.data("current");
									if(!current) { return; } 
									
									$(this.to.get("confirmText")).html(
										"Are you sure you want to remove "
										+ current.toString() +
										" from your contact list?"
									);
									
									var stage = htmlLoader.stage;
									stage.setChildIndex(this.to.htmlLoader, stage.numChildren-1);
									
									this.to.show();
								}
							},
							actions: { 
								keydown: function(event) { 
									var keyCode = event.keyCode; 
									air.trace("keydown: " + keyCode); 
									switch (keyCode) {
										case air.Keyboard.LEFT:
										this.prev(); 
										event.stopPropagation();
										break;
										case air.Keyboard.RIGHT:
										this.next(); 
										event.stopPropagation();
										break;
										case air.Keyboard.UP:
										case air.Keyboard.DOWN:
										this.edit(); 
										event.stopPropagation();
										break;
										case air.Keyboard.ESCAPE:
										this.close(); 
										event.stopPropagation();
										break;
										case air.Keyboard.DELETE:
										this.del();  
										event.stopPropagation();
										break;
									}
								}, 
								click: {  
									closedetails : function() { this.close(); }, 
									prevdetails: function() { this.prev(); },
									nextdetails: function() { this.next(); },
									backdetails: function() { this.close(); }, 
									editdetails: function() { this.edit(); }, 
									deletedetails: function() { this.del(); }
								}
							},  
							prev: function() {
								var prevRecord = this.app.data("list").prev();
								if(!prevRecord) {
									this.shake();
									return; 
								}
								this.app.data("current", prevRecord);   
								this.app.views("list").widgets("list").select(prevRecord.id);
								
								this.to("detail", { reverse: true} );
							}, 
							next: function() {
								var nextRecord = this.app.data("list").next();
								if(!nextRecord) {
									this.shake();
									return; 
								}  
								
								this.app.data("current", nextRecord);  
								this.app.views("list").widgets("list").select(nextRecord.id);
								
								this.to("detail", { reverse: false } ); 
							},
							edit: function() { this.to("edit"); },
							del: function() {  
								this.to("confirmDelete");
							},
							close: function() { 
								this.app.removedata("current");
							
								this.to("list");
							}
						}, 
						edit: { 
							path: "/view/test/blackbooksafe/edit.html",
							htmlLoader: { x: 120, y: 70 }, 
							widgets: { 
								form: { id: "form" }
							}, 
							transitions: { 
								list: function() { 
									this.from.zoomHide($.air.bounds.get(this.to.get("listPageBorder"))); 
									this.to.blenderShow();
								},
								detail: function() { 
									air.trace("edit to detail!");
									var current = this.app.data("current");
									
									air.trace(current);
									
									this.to.widgets("form").populate(current);
									
									//$(this.to.get("name")).html($(this.app).data("current").toString()); 
									this.to.flipX(this.from, true);
								}
							}, 
							actions: { 
								keydown: function(event) { 
									var keyCode = event.keyCode;
									air.trace("keydown: " + keyCode); 
									switch (keyCode) {
										case air.Keyboard.ESCAPE:
										this.close(); 
										event.stopPropagation();
										break;
										case air.Keyboard.ENTER:
										case air.Keyboard.NUMPAD_ENTER:
										this.submit(); 
										event.stopPropagation();
										break; 
									}
								},
								click: { 
									closeedit : function() { this.close(); }, 
									canceledit: function() { this.close(); },
									okedit: function() { this.submit(); }
								}
							},
							close: function() {
								var current = this.app.data("current");
								this.to(current ? "detail" : "list");
							}, 
							submit: function() { 	 
								var current = this.app.data("current");
							
								var model = this.app.models("contact"), 
									obj = this.widgets("form").read(model.build(current || {}));
							
								//read form - set model properties 
								function onSave(e, result) { 
									$(model).unbind("success", $.proxy(onSave, this));
									
									air.trace("successful model save");
									air.trace(result);
									for(var k in result) { air.trace(k + ": " + result[k]); }
									
									this.app.data("list").find({ id: result.id });
									this.app.data("current", result);
									
									
									this.to("detail");	 
								}
								
								function onError(e, text) { 
									$(model).unbind("error", $.proxy(onError, this));
									
									air.trace("model save error");
								}
								
								$(model)
								.bind("success", $.proxy(onSave, this))
								.bind("error", $.proxy(onError, this))
								.get(0).save(obj); 
							}
						}, 
						
						confirmDelete: {
							path: "/view/test/blackbooksafe/confirm-delete.html",
							htmlLoader: { x: 120, y: 70 },
							transitions: {
								detail: function(args){ 
									if(!args.confirmed) {
										this.from.hide();
										return;	
									}
									
									var current = this.app.data("current");
									if(!current) return;
	
									var model = this.app.models("contact"), 
										parms = { id: current.id }; 
									//read form - set model properties 
									function onDel(e, result) { 
										$(model).unbind("success", $.proxy(onDel, this));
										
										var list = this.app.data("list");
										list.remove(list.selectedIndex); 
										this.app.removedata("current");
	
										this.from.hide();
										this.to.to("list", { deleted: true }); 
									}
									
									function onError(e, text) { 
										$(model).unbind("success", $.proxy(onError, this));
										
										air.trace("model del error");
									}
									
									$(model)
									.bind("success", $.proxy(onDel, this))
									.bind("error", $.proxy(onError, this))
									.get(0).del(parms);  
								}
							}, 
							actions: { 
								keydown: function(event) {
									var keyCode = event.keyCode;
									switch(keyCode) {
										case air.Keyboard.ESCAPE:
										this.close(); 
										event.stopPropagation();
										break;
										case air.Keyboard.ENTER:
										case air.Keyboard.NUMPAD_ENTER:
										this.submit(); 
										event.stopPropagation();
										break; 
									}
								},
								click: {
									cancelconfirm: function() { this.close(); },
									okconfirm: function() { this.submit(); }
								}
							},
							close: function() { 
								this.to("detail", { confirmed: false });
							}, 
							submit: function() { 
								this.to("detail", { confirmed: true });
							}
						}, 
						
						about: {
							path: "/view/test/blackbooksafe/about.html",
							htmlLoader: { x: 91.5, y: 144 },
							transitions: {
								list: function(){
									this.from.hide();
								}
							}, 
							actions: { 
								keydown: function(event) {
									var keyCode = event.keyCode;
									switch(keyCode) {
										case air.Keyboard.ESCAPE: 
										case air.Keyboard.ENTER:
										case air.Keyboard.NUMPAD_ENTER:
										this.close(); 
										event.stopPropagation();
										break; 
									}
								},
								click: { 
									closeabout: function() { this.close(); }, 
									okabout: function() { this.close(); }
								}
							},
							close: function() { this.to("list"); }
						}
					}
				});
				
				function onStart() { 
					$(app).unbind("start", $.proxy(onStart, app));
					
					air.trace("application started");
					this.show(this.db.isInitialized() ? "login" : "newUser"); 
				};
				function onEnd() { 
					$(app).unbind("end", $.proxy(onEnd, app));
				};
				
				$(app).
				bind("start", $.proxy(onStart, app)).
				bind("end", $.proxy(onEnd, app));
				//app.start();
			});
		</script>
    </body>
</html>
