<html>
    <head>
        <title>New Adobe AIR Project</title>
        <script type="text/javascript" src="lib/air/AIRAliases.js"></script>
        <script type="text/javascript" src="lib/air/AIRIntrospector.js"></script>
        <script type="text/javascript" src="lib/air/AIRSourceViewer.js"></script>
		<script type="application/x-shockwave-flash" src="lib/as3corelib.swf"></script>
	        
		<script type="text/javascript" src="lib/jquery/jquery-1.4.2.big.js"></script>
		<script type="text/javascript" src="js/jquery.air.js"></script> 
    </head>
    <body>
    		
		<script type="text/javascript">
			$(function() {  
				var shell = $.air.mvp({ 
					models: {
						contact: {
							id: { type: "integer", primaryKey: true, autoIncrement: true },
							firstName: { type: "varchar", size: 32 },
							lastName: { type: "varchar", size: 32 },
							phone: { type: "varchar", size: 32 },
							email: { type: "varchar", size: 64 }, 
							website: { type: "varchar", size: 256 },
							birthDate: { type: "varchar", size: 32 },
							notes: { type: "varchar" },
							photo: { type: "blob" } 
						}
					},
					views: {
						login: { 
							path: "/view/test/blackbooksafe/login.html",
							position: { x: 70, y: 20 }, 
							getPassword: function() { return this.$("#password"); }, 
							getOk: function() { return this.$("#oklogin"); }, 
							getClose: function() { return this.$("#closelogin"); }
						},
						newUser: {
							path: "/view/test/blackbooksafe/new-user.html",
							position: { x: 70, y: 20 },
							getUserText: function() { return this.$("#newUser_text"); }, 
							getNewPassword: function() { return this.$("#new_password"); },
							getConfirmPassword: function() { return this.$("#confirm_password"); } 
						},
						list: {
							path: "/view/test/blackbooksafe/list.html",
							position: { x: 0, y: 0 },
							getList: function() { return this.$("#list"); }, 
							getListBorder: function() { return this.$("#listPageBorder"); }
						},
						detail: {
							path: "/view/test/blackbooksafe/detail.html",
							position: { x: 120, y: 70 }, 
							getFirstName: function() { return this.$("#firstName"); },
							getLastName: function() { return this.$("#lastName"); },
							getPhone: function() { return this.$("#phone"); },
							getEmail: function() { return this.$("#email"); },
							getWebsite: function() { return this.$("#website"); },
							getBirthday: function() { return this.$("#birthday"); },
							getNotes: function() { return this.$("#notes"); },
							getPhoto: function() { return this.$("#photo"); }
						}, 
						edit: {
							path: "/view/test/blackbooksafe/edit.html",
							position: { x: 120, y: 70 }, 
							getFirstName: function() { return this.$("#firstName"); },
							getLastName: function() { return this.$("#lastName"); },
							getPhone: function() { return this.$("#phone"); },
							getEmail: function() { return this.$("#email"); },
							getWebsite: function() { return this.$("#website"); },
							getBirthday: function() { return this.$("#birthday"); },
							getNotes: function() { return this.$("#notes"); },
							getPhoto: function() { return this.$("#photo"); }
						},
						confirmDelete: {
							path: "/view/test/blackbooksafe/confirm-delete.html",
							position: { x: 120, y: 70 },
							getConfirmationText: function() { return this.$("#confirmText"); } 
						},
						about: {
							path: "/view/test/blackbooksafe/about.html",
							position: { x: 91.5, y: 144 }
						}
					},
					presenters: { 
						login: {
							markInvalid: function() {
								this.shake();
								
								this.view.getPassword().addClass("badPassword");
							}, 
							submit: function() { 
								var password = $.trim(this.view.getPassword().val());
								
								if (password === "") {
									this.markInvalid();
									return;
								} 
							
								this.authService.login(
									password, 
									$.proxy(function() { this.trigger("loggedIn"); }, this),
									$.proxy(function() { this.trigger("logInFailed"); }, this) 
								);
							},
							go: function() {
								this.view.getPassword().focus();					
							},  
							events: {
								keydown: {
									enter: function() { this.submit(); },
									numpad_enter: function() { this.submit(); }
								}, 
								click: {
									"#oklogin": function() { this.submit(); }, 
									"#closelogin": function() { this.exit(); }
								}
							}
						},
						newUser: {
							setUserText: function(text) {
								this.view.getUserText().html('<span class="hint">' + text + '</span>'); 
							}, 
							markInvalid: function() {
								this.shake();
								
								this.view.getNewPassword().addClass("badPassword");
								this.view.getConfirmPassword().addClass("badPassword");
							}, 
							submit: function() {
								var newPassword = $.trim(this.view.getNewPassword().val()), 
									confirmPassword =  $.trim(this.view.getConfirmPassword().val());

								if (newPassword === "") {
									this.setUserText("Please specifiy a password!");
									this.markInvalid(); 
									return;
								} 
								
								var strongPasswordPattern = /(?=^.{8,32}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$/;
								if(!strongPasswordPattern.test(newPassword)) { 
									this.setUserText("The password should be 8-32 characters long and contain at least one lowercase letter, one uppercase letter and one number or symbol.");
									this.markInvalid(); 
									return;
								}
								
								if(newPassword !== confirmPassword) {
									this.setUserText("The two passwords do not match.");
									this.markInvalid(); 
									return;
								}
							
								this.authService.login(
									newPassword, 
									$.proxy(function() { this.trigger("userCreated"); }, this),
									$.proxy(function() { this.trigger("userCreateFailed"); }, this) 
								);
							},
							go: function() { 
								this.view.getNewPassword().focus();
							}, 
							events: {
								keydown: {
									enter: function() {  this.submit(); },
									numpad_enter: function() { this.submit(); }
								}, 
								click: {
									"#okcreatepass": function() { this.submit(); }
								}
							}
						},
						list: { 
							about: function() { this.trigger("displayAbout"); },
							add: function() { this.trigger("addContact"); },
							displayContact: function() { 
								
//								this.trigger("displayContact", { 
//									prevId: this.listWidget.prevIndex, 
//									id: this.listWidget.selectedIndex, 
//									nextId: this.listWidget.nextIndex
//								});
							}, 
							detail: function() { 
								this.displayContact(); 
							
							}, 
							next: function() { 
//								this.listWidget.next();
								this.displayContact();
							},
							prev: function() { 
//								this.listWidget.prev();
								this.displayContact();
							},
							go: function() { 
								//this.listWidget = new $.air.ui.List(this.view.getList());
								//this.listWidget.bind("click", $.proxy(function() { this.detail(); }, this));
	
								function onSuccess(e, result) { 
									if(!result) { return; }
									
									this.view.getListBorder().html("");
									
									var data = result.data || [];
									for(var i = 0; i < data.length; i++) {
										var item = data[i];
 
 										this.view.getListBorder()
											.append(
												$(document.createElement("div"))
													.addClass("listDiv")
													.html(
														"<table><tr>" + 
															"<td><img id='img_" + item.id  + "' width=36 height=48 class='photoSmall' src='" + "" + "' /></td>" +
															"<td><span class='tableFieldName listValue'>" + item.firstName + " " + item.lastName + "</span><span class='tableFieldName listValue'>" + item.phone + "</span></td>" +
														"</tr></table>"
													)
											); 
									}
									
									//this.listWidget.data(result);
//									if(this.id) { this.listWidget.select(this.id); }	
								}
								function onError(ex) { }
								
								this.contactService.get({}, $.proxy(onSuccess, this), $.proxy(onError, this)); 
							},
							events: { 
								keydown: {  
									escape: function() { this.exit(); }, 
									enter: function(){ this.detail(); },
									down: function(){ this.next(); }, 
									up: function(){ this.prev(); }
								},
								click: { 
									"#viewAbout_btn": function(){ this.about(); }, 
									"#add": function(){ this.add(); }, 
									"#minimize": function(){ this.minimize(); },
									"#close": function(){ this.exit(); }
								}
							}
						},
						detail: {   
							setActiveContact: function(contact) {
								this.activeContact = contact;
								
								if(!this.activeContact) return; 
								this.setForm(this.activeContact);
							}, 
							setForm: function(contact) {
								this.view.getFirstName().text(contact.firstName);
								this.view.getLastName().text(contact.lastName);
								this.view.getPhone().text(contact.phone);
								this.view.getEmail().text(contact.email);
								this.view.getWebsite().text(contact.website);
								this.view.getBirthday().text(contact.birthDate);
								this.view.getNotes().text(contact.notes);
								
								//... photo
							},
							close: function() {
								this.trigger("displayContactCanceled");
							}, 
							prev: function() { 
								this.trigger("prevContact");
							}, 
							next: function() {
								this.trigger("nextContact");
							}, 
							edit: function() {
								alert(this.activeContact.id);
								this.trigger("editContact", { id: this.activeContact.id });
							}, 
							del: function() { 
								this.trigger("deleteContact", { id: this.activeContact.id });
							}, 
							go: function() {  
								if (this.id) { 
									if (this.deleted) { 
										function onSuccess(){ this.trigger("contactDeleted"); }
										function onError(ex){ this.trigger("contactDeleteFailed"); }
										
										this.contactService.del({ id: this.id }, $.proxy(onSuccess, this), $.proxy(onError, this));
									}
									else {
										function onSuccess(e, result){
											if(!result) return;
											var data = result.data || [],
												contact = data[0];
											
											this.setActiveContact(contact);
										}
										function onError(ex) { }
										
										this.contactService.get({ id: this.id }, $.proxy(onSuccess, this), $.proxy(onError, this));
									}
								}
							},
							events: {
								keydown: {
									escape: function() { this.close(); },
									left: function() { this.prev(); },
									right: function() { this.next(); },
									up: function() { this.edit(); },
									down: function() { this.edit(); },
									del: function() { this.del(); }
								}, 
								click: {
									"#closedetails": function() { this.close(); }, 
									"#prevdetails": function() { this.prev(); },
									"#nextdetails": function() { this.next(); },
									"#backdetails": function() { this.close(); }, 
									"#editdetails": function() { this.edit(); }, 
									"#deletedetails": function() { this.del(); }
								}, 
							}
						}, 
						edit: {  
							setActiveContact: function(contact) {
								this.activeContact = contact;
								this.setForm(this.activeContact);
							}, 
							setForm: function(contact) {
								this.view.getFirstName().val(contact.firstName);
								this.view.getLastName().val(contact.lastName);
								this.view.getPhone().val(contact.phone);
								this.view.getEmail().val(contact.email);
								this.view.getWebsite().val(contact.website);
								this.view.getBirthday().val(contact.birthDate);
								this.view.getNotes().val(contact.notes);
								
								//... photo
							}, 
							readForm: function() { 
								var contact = this.activeContact;

								contact.firstName = this.view.getFirstName().val(); 
								contact.lastName = this.view.getLastName().val(); 
								contact.phone = this.view.getPhone().val();
								contact.email = this.view.getEmail().val();
								contact.website = this.view.getWebsite().val();
								contact.birthDate = this.view.getBirthday().val();
								contact.notes = this.view.getNotes().val();												
				
								//... photo?
								
								return contact;
							}, 
							close: function() { this.trigger("editContactCanceled"); },
							submit: function() {
								//save contact
								var contact = this.readForm();

								function onSuccess(e, result) {  
									this.trigger("contactUpdated", { id: result.lastInsertRowID });
								}
								function onError(e, error) { 
									alert("error saving contact"); 
								}
								this.contactService.save(contact, $.proxy(onSuccess, this), $.proxy(onError, this));
							},
							events: {
								keydown: {
									escape: function() { this.close(); },
									enter: function() { this.submit(); },
									numpad_enter: function() { this.submit(); }
								}, 
								click: {
									"#closeedit" : function() { this.close(); }, 
									"#canceledit": function() { this.close(); },
									"#okedit": function() { this.submit(); }
								} 
							}, 
							go: function() {  
									
								if(this.id) {
									//edit 
									function onSuccess(contact) { 
										this.setActiveContact(contact);
									}
									function onError(ex) { }
								
									this.contactService.get( { id: this.id }, $.proxy(onSuccess, this), $.proxy(onError, this) ); 
								} else { 
									//add  
									this.setActiveContact(this.contactService.create());
								} 
			
								this.stage.focus = this.view.htmlLoader;
								this.view.getFirstName().focus();
							} 
						},
						confirmDelete: { 
							setActiveContact: function(contact) {
								this.activeContact = contact;
								this.setForm();
							},
							setForm: function() { 
								this.view.getConfirmationText().html(this.getConfirmation());
							}, 
							getConfirmation: function() {
								var contact = this.activeContact, 
									contactName = contact.firstName + " " + contact.lastName;
								
								return  "Are you sure you want to remove " + contactName + " from your contact list?";
							}, 
							close: function() {
								this.trigger("confirmDeleteCanceled", { id: this.activeContact.id });
							},
							submit: function() {  
								this.trigger("deleteConfirmed", { id: this.activeContact.id }); 
							},
							go: function() { 
								function onSuccess(e, result){
									if(!result) return;
									var data = result.data || [],
										contact = result.data[0];
									
									this.setActiveContact(contact);
								}
								function onError(ex) { } 
								
								this.contactService.get( { id: this.id }, $.proxy(onSuccess, this), $.proxy(onError, this));
							}, 
							events: {
								keydown: {
									escape: function() { this.close(); },
									enter: function() { this.submit(); },
									numpad_enter: function() { this.submit(); }
								}, 
								click: {
									"#cancelconfirm": function() { this.close(); },
									"#okconfirm": function() { this.submit(); }
								}
							} 
						},
						about: {  
							close: function() { this.trigger("aboutCanceled"); },
//							go: function() {}, 
							events: {
								keydown: {
									escape: function(){ this.close(); },
									enter: function(){ this.close(); },
									numpad_enter: function(){ this.close(); }
								},
								click: {
									"#closeabout": function(){ this.close(); },
									"#okabout": function(){ this.close(); }
								}
							} 
						}
					},
					
					
					
					
					
					transitions: {  
						list: { 
							detail: function() { 
								this.from.blenderHide(); 
								this.to.zoomShow(this.from.view.getListBorder());
							}, 
							edit: function() {  
								this.from.blenderHide();

								this.to.zoomShow(this.from.view.getListBorder());
							}, 
							about: function() {
								alert("here");
								this.to.wavesShow();
							}
						},
						detail: { 
							list: function() {   
								//todo: move to presenter
								if (this.from.deleted) {
									this.from.blenderDissolve();
								} 
							
								this.from.zoomHide(this.to.view.getListBorder());
								this.to.blenderShow();
							},
							detail: function(args) {  
								//todo: move this directly into presenter
								this.from.flipY(args.reverse);
							}, 
							edit: function() {
								this.from.flipX(this.to, false);
							},
							confirmDelete: function() { 
								this.to.bringToFront();
								this.to.show();
							}
						}, 
						edit: {
							list: function() { 
								this.from.zoomHide(this.to.view.getListBorder());
								this.to.blenderShow();
							},
							detail: function() { 
								this.to.flipX(this.from, true);
							}
						},
						confirmDelete: {  
							detail: function(args){ this.from.hide(); }
						},
						about: { 
							list: function(){ this.from.wavesHide(); }
						}
					}, 
					
					
					services: { 
						auth: {
							login: function(pwd, onSuccess, onFailure) { 
								this.db.open(pwd, onSuccess, onFailure);  
							}
						}, 
						contact: {
							create: function() {
								return this.contactModel.build();
							}, 
							get: function(criteria, onSuccess, onFailure) { 
								this.db.tables("contact").get(criteria, onSuccess, onFailure);
							},
							save: function(contact, onSuccess, onFailure) {
								this.db.tables("contact").set(contact, onSuccess, onFailure);
							},
							del: function(criteria, onSuccess, onFailure) {
								this.db.tables("contact").del(criteria, onSuccess, onFailure); 
							}
						}
					}, 
					
					
					
					
					
					
					shell: { 
						getAuthDependencies: function() { 
							return { 
								authService: this.services("auth", { 
									db: this.db 
								}) 
							}; 
						},
						getContactDependencies: function(args) {  
							return $.extend({}, {  
								contactService: this.services("contact", { 
									contactModel: this.models("contact"), 
									db: this.db 
								}), 
							}, args || {}); 
						}, 
						login: function() { 
							this.present("login", this.getAuthDependencies()); 
						}, 
						newUser: function() {
							this.present("newUser", this.getAuthDependencies()); 
						}, 
						about: function() { 
							this.present("about"); 
						},
						list: function(args) {  
							this.present("list", this.getContactDependencies(args)); 
						},
						detail: function(args) {    
							this.present("detail", this.getContactDependencies(args)); 
						},
						edit: function(args) {   
							this.present("edit", this.getContactDependencies(args)); 
						},
						confirmDelete: function(args) { 
							this.present("confirmDelete", this.getContactDependencies(args)); 
						}, 
						prev: function() { this.active("list").prev(); }, 
						next: function() { this.active("list").next(); }, 
						
						events: { 
							//login & newuser events
							loggedIn: function() { this.list(); }, //login => list
							logInFailed: function() { }, 
							
							userCreated: function() { this.list(); }, //new user => list
							userCreateFailed: function() { }, 
							
							//list events
							displayAbout: function(args) { this.about(); }, //list => about
							displayContact: function(args) { this.detail(args); }, //list => detail
							addContact: function(args) { this.edit(); }, //list => add
							
							//edit events
							contactUpdated: function(args) { this.detail(args); }, //edit => detail
							editContactCanceled: function(args) { if(args) { this.detail(args); } else { this.list(); } }, //edit => detail/list
							
							//display events
							displayContactCanceled: function(args) { this.list(args); }, //detail => list
							prevContact: function(args) { this.prev(); }, //detail => detail (prev)
							nextContact: function(args) { this.next(); }, //detail => detail (next)
							editContact: function(args) { this.edit(args); }, //detail => edit
							deleteContact: function(args) { this.confirmDelete(args); }, //detail => confirm delete
							contactDeleted: function(args) { this.list(args); },  //detail => list
							
							//confirm delete events
							deleteConfirmed: function(args) { this.detail( $.extend({}, { deleted: true }, args || {} )); }, //confirm delete => detail (contact deleted)
							confirmDeleteCanceled: function(args) { this.detail(args); }, //confirm delete => detail 
							
							//about events
							aboutCanceled: function(args) { this.list(args); } //about => list
						},
						
						go: function() {  
							this.db = new $.air.Database("bbs-03", { 
								tables: { 
									"contact" : this.models("contact").toTable() 
								} 
							}); 

							if (this.db.isInitialized()) {  
								this.login();
							}
							else { 
								this.newUser();
							}
						}
					}
				});			
			});
		</script>
    </body>
</html>
