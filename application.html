<html>
    <head>
        <title>New Adobe AIR Project</title>
        <script type="text/javascript" src="lib/air/AIRAliases.js"></script>
        <script type="text/javascript" src="lib/air/AIRIntrospector.js"></script>
        <script type="text/javascript" src="lib/air/AIRSourceViewer.js"></script>
		<script type="application/x-shockwave-flash" src="lib/as3corelib.swf"></script>
	        
		<script type="text/javascript" src="lib/jquery/jquery-1.4.2.big.js"></script>
		<script type="text/javascript" src="js/jquery.air.js"></script> 
    </head>
    <body>
    		
		<script type="text/javascript">
			$(function() {  
				var shell = $.air.mvp({
					db: { key: "bbs2" },
					models: {
						contact: {
							id: { type: "integer", primaryKey: true, autoIncrement: true },
							firstName: { type: "varchar", size: 32 },
							lastName: { type: "varchar", size: 32 },
							phone: { type: "varchar", size: 32 },
							email: { type: "varchar", size: 64 }, 
							website: { type: "varchar", size: 256 },
							birthDate: { type: "varchar", size: 32 },
							notes: { type: "varchar" },
							photo: { type: "blob" },
							toString: function() { return this.firstName + " " + this.lastName; },
							toHTML: function() { 
								return "<table><tr>" + 
											"<td><img id='img_" + this.id  + "' width=36 height=48 class='photoSmall' src='" + "" + "' /></td>" +
											"<td><span class='tableFieldName listValue'>" + this.firstName + " " + this.lastName + "</span><span class='tableFieldName listValue'>" + this.phone + "</span></td>" +
										"</tr></table>";
							}
						}
					},
					views: {
						login: { 
							path: "/view/test/blackbooksafe/login.html",
							position: { x: 70, y: 20 }, 
							getUsername: function() { return this.$("#username"); }, //function() { return $("#username", this); }
							getPassword: function() { return this.$("#password"); }, 
							getOk: function() { return this.$("#oklogin"); }, 
							getClose: function() { return this.$("#closelogin"); }
						},
						newUser: {
							path: "/view/test/blackbooksafe/new-user.html",
							position: { x: 70, y: 20 },
							getPassword: function() { return this.$("#password"); }, 
							getOk: function() { return this.$("#okcreatepass"); }
						},
						list: {
							path: "/view/test/blackbooksafe/list.html",
							position: { x: 70, y: 20 },
							getList: function() { return this.$("#list"); }, 
							getListBorder: function() { return this.$("#listPageBorder"); }
						},
						detail: {
							path: "/view/test/blackbooksafe/detail.html",
							position: { x: 120, y: 70 }
						}, 
						edit: {
							path: "/view/test/blackbooksafe/edit.html",
							position: { x: 120, y: 70 }, 
							getFirstName: function() { return this.$("#editFirstName"); },
							getLastName: function() { return this.$("#editLastName"); }
						},
						confirmDelete: {
							path: "/view/test/blackbooksafe/confirm-delete.html",
							position: { x: 120, y: 70 },
							getConfirmationText: function() { return this.$("#confirmText"); } 
						},
						about: {
							path: "/view/test/blackbooksafe/about.html",
							position: { x: 91.5, y: 144 }
						}
					},
					presenters: { 
						login: {
							submit: function() { 
								var username = this.view.getUsername().val(), 
									password = this.view.getPassword().val();
								
								this.trigger(
									this.authService.login(username, password) ? 
									"loggedIn" : "logInFailed"
								);
							}, 
							view: {
								events: {
									keydown: {
										enter: function() { this.submit(); },
										numpad_enter: function() { this.submit(); }
									}, 
									click: {
										oklogin: function() { this.submit(); }, 
										closelogin: function() { this.exit(); }
									}
								}
							},
							go: function() { 
//								this.view
//									.bind("keydown", function(keyCode) {
//										switch(keyCode) { 
//											case "enter":
//											case "numpad_enter":
//											this.submit();
//											break;
//										}
//									})
//									.getOk().bind("click", $.proxy(function() {
//										this.submit();
//									}, this))
//									.getClose().bind("click", $.proxy(function() { 
//										this.submit();
//									}, this)); 
							}
						},
						newUser: {
							submit: function() {
								var username = this.view.getUsername().val(), 
									password =  this.view.getPassword().val();
									
								this.trigger(
									this.authService.create(username, password) ? 
									"userCreated" : "userCreateFailed"
								);
							},
							view: {
								events: {
									keydown: {
										enter: function() { this.submit(); },
										numpad_enter: function() { this.submit(); }
									}, 
									click: {
										okcreatepass: function() { this.submit(); }
									}
								} 
							},
							go: function() { 
//								this.view
//									.bind("keydown", $.proxy(function(keyCode) {
//										switch(keyCode) { 
//											case "enter":
//											case "numpad_enter":
//											this.submit();
//											break;
//										}
//									}, this))
//									.getOk().bind("click", $.proxy(function() { 
//										this.submit();
//									}, this));
							}
						},
						list: { 
							about: function() { this.trigger("displayAbout"); },
							add: function() { this.trigger("addContact"); },
							displayContact: function() { 
								var listWidget = this.view.getListWidget();
								
								this.trigger("displayContact", { 
									prevId: listWidget.prevIndex, 
									id: listWidget.selectedIndex, 
									nextId: listWidget.nextIndex
								});
							}, 
							detail: function() { this.displayContact(); }, 
							next: function() { 
								this.view.getListWidget().next();
								this.displayContact();
							},
							prev: function() {
								//todo: set prev selected record on view list
								this.view.getListWidget().prev();
								this.displayContact();
							},
							view: {
								events: { 
									keydown: {  
										escape: function() { this.exit(); }, 
										enter: function(){ this.detail(); },
										down: function(){ this.next(); }, 
										up: function(){ this.prev(); }
									},
									click: { 
										viewAbout_btn: function(){ this.about(); }, 
										add: function(){ this.add(); }, 
										minimize: function(){ this.minimize(); },
										close: function(){ this.exit(); }
									}
								}
							},
							go: function() { 
								var listWidget = this.view.getListWidget()
								listWidget.bind("click", $.proxy(this.detail, this));
								
								function onSuccess(contacts) {
									listWidget.data(contacts);
									if(this.data("id")) { listWidget.select(this.data("id")); }	
								}
								function onError(ex) { }
								
								this.contactService.get({}, $.proxy(onSuccess, this), $.proxy(onError, this));
							}
						},
						detail: { 
							close: function() {
								this.trigger("displayContactCanceled");
							}, 
							prev: function() { 
								this.trigger("prevContact");
							}, 
							next: function() {
								this.trigger("nextContact");
							}, 
							edit: function() {
								this.trigger("editContact", this.data("activeContact"));
							}, 
							del: function() { 
								this.trigger("deleteContact", this.data("activeContact"));
							},
							view: {
								events: {
									keydown: {
										escape: function() { this.close(); },
										left: function() { this.prev(); },
										right: function() { this.next(); },
										up: function() { this.edit(); },
										down: function() { this.edit(); },
										del: function() { this.del(); }
									}, 
									click: {
										closedetails: function() { this.close(); }, 
										prevdetails: function() { this.prev(); },
										nextdetails: function() { this.next(); },
										backdetails: function() { this.close(); }, 
										editdetails: function() { this.edit(); }, 
										deletedetails: function() { this.del(); }
									}, 
								}
							}, 
							go: function() {
								if (this.data("id")) {
									
									if (this.data("deleted")) { 
										function onSuccess(){ this.trigger("contactDeleted"); }
										function onError(ex){ this.trigger("contactDeleteFailed"); }
										
										this.contactService.del({ id: this.data("id") }, $.proxy(onSuccess, this), $.proxy(onError, this));
									}
									else {
										function onSuccess(contact){
											this.data("activeContact", contact);
											
											this.view.getFirstName().val(contact.firstName);
											this.view.getLastName().val(contact.lastName);
										}
										function onError(ex) { }
										
										this.contactService.get({ id: this.data("id") }, $.proxy(onSuccess, this), $.proxy(onError, this));
									}
								}
							}
						}, 
						edit: {
							close: function() { this.trigger("editContactCanceled"); },
							submit: function() {
								//save contact
								var contact = this.readForm();

								function onSuccess() { 
									this.trigger("contactUpdated");
								}
								function onError(ex) { alert("error saving contact"); }
								this.contactService.save(contact, $.proxy(onSuccess, this), $.proxy(onError, this));
							},
							setForm: function(contact) {
								this.view.getFirstName().val(contact.firstName);
								this.view.getLastName().val(contact.lastName);
								//...
							}, 
							readForm: function() { 
								var contact = this.data("activeContact");
								contact.firstName = this.view.getFirstName().val();
								contact.lastName = this.view.getLastName().val();
								//...
								
								return contact;
							},
							view: {
								events: {
									keydown: {
										escape: function() { this.close(); },
										enter: function() { this.submit(); },
										numpad_enter: function() { this.submit(); }
									}, 
									click: {
										closeedit : function() { this.close(); }, 
										canceledit: function() { this.close(); },
										okedit: function() { this.submit(); }
									} 
								}
							}, 
							go: function() {
								function onSuccess(contact) {
									this.data("activeContact", contact);
									this.setForm(contact);
								}
								function onError(ex) { }
									
								if(this.data("id")) {
									//edit 
									this.contactService.get( { id: this.data("id")}, $.proxy(onSuccess, this), $.proxy(onError, this) ); 
								} else { 
									//add 
									this.contactService.create( $.proxy(onSuccess, this), $.proxy(onError, this) );
								} 
							} 
						},
						confirmDelete: { 
							getConfirmation: function() {
								var contact = this.data("activeContact"), 
									contactName = contact.firstName + " " + contact.lastName;
								
								return  "Are you sure you want to remove " + contactName + " from your contact list?";
							}, 
							close: function() {
								this.trigger("confirmDeleteCanceled");
							},
							submit: function() {  
								this.trigger("deleteConfirmed"); 
							},
							view: { 
								events: {
									keydown: {
										escape: function() { this.close(); },
										enter: function() { this.submit(); },
										numpad_enter: function() { this.submit(); }
									}, 
									click: {
										cancelconfirm: function() { this.close(); },
										okconfirm: function() { this.submit(); }
									}
								} 
							},
							go: function() {
								function onSuccess(contact){ 
									this.data("activeContact", contact);
									
									this.view.getConfirmationText().html(this.getConfirmation());
								}
								function onError(ex) { }
								
								this.contactService.get( { id: this.data("id") }, 
									$.proxy(onSuccess, this), 
									$.proxy(onError, this)
								);
							}
						},
						about: {  
							close: function() { this.trigger("aboutCanceled"); },  
							view: {
								events: {
									keydown: {
										escape: function(){ this.close(); },
										enter: function(){ this.close(); },
										numpad_enter: function(){ this.close(); }
									},
									click: {
										closeabout: function(){ this.close(); },
										okabout: function(){ this.close(); }
									}
								}
							},
							go: function() {}
						}
					},
					transitions: {
						login: {  
							list: function() { 
								//this should be default transition
								this.from.hide();
								this.to.show();
							}
						},
						newUser: {
							list: function() {
								this.from.hide();
								this.to.show();
							}
						},
						list: { 
							detail: function() { 
								this.from.blenderHide(); 
								this.to.zoomShow($.air.bounds.get(this.from.view.getListBorder()));
								//this.to.zoomShow(this.from.view.getListBorder());
							}, 
							edit: function() {  
								this.from.blenderHide();

								var bounds = $.air.bounds.get(this.from.view.getListBorder());
								air.trace("bounds: " + bounds);
								this.to.zoomShow(bounds); 
								//this.to.zoomShow(this.from.view.getListBorder());
							}, 
							about: function() {
								this.to.show();
							}
						},
						detail: { 
							list: function() {   
								//todo: move to presenter
								if (this.from.data("deleted")) {
									this.from.blenderDissolve();
								} 
							
								var bounds = $.air.bounds.get(this.to.view.getListBorder()); 
								this.from.zoomHide(bounds);
								//this.from.zoomHide(this.to.view.getListBorder());
								
								this.to.blenderShow();
							},
							detail: function(args) {  
								//todo: move this directly into presenter
								this.from.flipY(args.reverse);
							}, 
							edit: function() {
								this.from.flipX(this.to, false);
							},
							confirmDelete: function() { 
								//todo: change this to general method
								
								var stage = htmlLoader.stage;
								stage.setChildIndex(this.to.htmlLoader, stage.numChildren-1);
								//this.to.bringToFront();
								
								this.to.show();
							}
						}, 
						edit: {
							list: function() { 
								this.from.zoomHide($.air.bounds.get(this.to.view.getListBorder())); 
								//this.from.zoomHide(this.to.view.getListBorder());
								this.to.blenderShow();
							},
							detail: function() { 
								this.to.flipX(this.from, true);
							}
						},
						confirmDelete: {  
							detail: function(args){ this.from.hide(); }
						},
						about: { 
							list: function(){ this.from.hide(); }
						}
					}, 
					services: {
						auth: { 
							create: function(password) { 
							
							}, 
							login: function(username, password) { 
								return true;	
							}
						}, 
						contact: {
							get: function(criteria) {
								
							},
							save: function(contact) {
								
							},
							del: function(id) {
								
							}
						}
					}, 
					shell: { 
						login: function() {
							this.stage(this.presenters("login", { view: this.views("login"), authService: this.services("auth") }) );
						}, 
						newUser: function() {
							this.stage(this.presenters("newUser", { view: this.views("newUser"), authService: this.services("auth") }));
						}, 
						about: function() { 
							this.stage(this.presenters("about", { view: this.views("about") })); 
						},
						list: function(args) { 
							var dependencies = { 
								view: this.views("list"), 
								contactService: this.services("contact"), 
								data: args || {} 
							};
							this.stage(this.presenters("list", dependencies));
						},
						detail: function(args) {  
							var dependencies = { 
								view: this.views("detail"), 
								contactService: this.services("contact"), 
								data: args || {}
							};
							this.stage(this.presenters("detail", dependencies));
						},
						edit: function(args) { 
							var dependencies = { 
								view: this.views("edit"), 
								contactService: this.services("contact"), 
								data: args || {}
							};
							this.stage(this.presenters("edit", dependencies));
						},
						confirmDelete: function(args) {
							var dependencies = {
								view: this.views("confirmDelete"),
								contactService: this.services("contact"),
								data: args || {}
							};
							this.stage(this.presenters("confirmDelete", dependencies));
						}, 
						prev: function() { this.staged("list").prev(); }, 
						next: function() { this.staged("list").next(); }, 
						bus: {  
							events: { 
								//login & newuser events
								loggedIn: function() { this.list(); }, //login => list
								logInFailed: function() { }, 
								
								userCreated: function() { this.list(); }, //new user => list
								userCreateFailed: function() { }, 
								
								//list events
								displayAbout: function(args) { this.about(); }, //list => about
								displayContact: function(args) { this.detail(args); }, //list => detail
								addContact: function(args) { this.edit(); }, //list => add
								
								//edit events
								contactUpdated: function(args) { this.detail(args); }, //edit => detail
								editContactCanceled: function(args) { if(args.id) { this.detail(args); } else { this.list(); } }, //edit => detail/list
								
								//display events
								displayContactCanceled: function(args) { this.list(args); }, //detail => list
								prevContact: function(args) { this.prev(); }, //detail => detail (prev)
								nextContact: function(args) { this.next(); }, //detail => detail (next)
								editContact: function(args) { this.edit(args); }, //detail => edit
								deleteContact: function(args) { this.confirmDelete(args); }, //detail => confirm delete
								contactDeleted: function(args) { this.list(args); },  //detail => list
								
								//confirm delete events
								deleteConfirmed: function(args) { this.detail( $.extend({ deleted: true }, args || {} )); }, //confirm delete => detail (contact deleted)
								confirmDeleteCanceled: function(args) { this.detail(args); }, //confirm delete => detail 
								
								//about events
								aboutCanceled: function(args) { this.list(args); } //about => list
							}
						},
						go: function() {
							if (this.db.isInitialized()) {
								this.login();
							}
							else {
								this.newUser();
							}
						}
					}
				});			
			});
		</script>
    </body>
</html>
