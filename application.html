<html>
    <head>
        <title>New Adobe AIR Project</title>
		
        <link href="lib/jquery.ui/css/ui-lightness/jquery-ui-1.8.7.custom.css" rel="stylesheet" type="text/css"/>
		
        <script type="text/javascript" src="lib/air/AIRAliases.js"></script>
        <script type="text/javascript" src="lib/air/AIRIntrospector.js"></script>
        <script type="text/javascript" src="lib/air/AIRSourceViewer.js"></script>
		<script type="application/x-shockwave-flash" src="lib/as3corelib.swf"></script>
	        
		<script type="text/javascript" src="lib/jquery/jquery-1.4.2.big.js"></script>
		<script type="text/javascript" src="js/jquery.air.js"></script> 
		
		<script type="text/javascript" src="lib/jquery.ui/jquery-ui-1.8.7.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery.air.ui.js"></script> 
    </head>
    <body>
    		
		<script type="text/javascript"> 

			$(function() { 
				
				var contactModel =  {
						id: { type: "key" },
						firstName: { type: "string", size: 32 },
						lastName: { type: "string", size: 32 },
						phone: { type: "string", size: 32 },
						email: { type: "string", size: 64 }, 
						website: { type: "string", size: 256 },
						birthDate: { type: "string", size: 32 },
						notes: { type: "string" },
						photo: { type: "image" } 
					};
			
				var loginView = { 
						path: "/view/test/blackbooksafe/login.html",
						position: { x: 70, y: 20 }, 
						getPassword: function() { return this.$("#password"); }, 
						getOk: function() { return this.$("#oklogin"); }, 
						getClose: function() { return this.$("#closelogin"); }
					}, 
					loginPresenter = {
						markInvalid: function() {
							this.shake();
							
							this.view.getPassword().addClass("badPassword");
						}, 
						submit: function() { 
							var password = $.trim(this.view.getPassword().val());
							
							if (password === "") {
								this.markInvalid();
								return;
							} 
						
							this.authService.login(
								password, 
								$.proxy(function() { this.trigger("loggedIn"); }, this),
								$.proxy(function() { this.markInvalid(); }, this) 
							);
						},
						go: function() {
							this.view.getPassword().focus();					
						},  
						events: {
							keydown: {
								enter: function() { this.submit(); },
								numpad_enter: function() { this.submit(); }
							}, 
							click: {
								"#oklogin": function() { this.submit(); }, 
								"#closelogin": function() { this.exit(); }
							}
						}
					}, 
					loginTransitions = {};
					
				var newUserView = {
						path: "/view/test/blackbooksafe/new-user.html",
						position: { x: 70, y: 20 },
						getUserText: function() { return this.$("#newUser_text"); }, 
						getNewPassword: function() { return this.$("#new_password"); },
						getConfirmPassword: function() { return this.$("#confirm_password"); } 
					}, 
					newUserPresenter = {
						setUserText: function(text) {
							this.view.getUserText().html('<span class="hint">' + text + '</span>'); 
						}, 
						markInvalid: function() {
							this.shake();
							
							this.view.getNewPassword().addClass("badPassword");
							this.view.getConfirmPassword().addClass("badPassword");
						}, 
						submit: function() {
							var newPassword = $.trim(this.view.getNewPassword().val()), 
								confirmPassword =  $.trim(this.view.getConfirmPassword().val());
	
							if (newPassword === "") {
								this.setUserText("Please specifiy a password!");
								this.markInvalid(); 
								return;
							} 
							
							var strongPasswordPattern = /(?=^.{8,32}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$/;
							if(!strongPasswordPattern.test(newPassword)) { 
								this.setUserText("The password should be 8-32 characters long and contain at least one lowercase letter, one uppercase letter and one number or symbol.");
								this.markInvalid(); 
								return;
							}
							
							if(newPassword !== confirmPassword) {
								this.setUserText("The two passwords do not match.");
								this.markInvalid(); 
								return;
							}
						
							this.authService.login(
								newPassword, 
								$.proxy(function() { this.trigger("userCreated"); }, this),
								$.proxy(function() { this.markInvalid(); }, this) 
							);
						},
						go: function() { 
							this.view.getNewPassword().focus();
						}, 
						events: {
							keydown: {
								enter: function() {  this.submit(); },
								numpad_enter: function() { this.submit(); }
							}, 
							click: {
								"#okcreatepass": function() { this.submit(); }
							}
						}
					}, 
					newUserTransitions = {};
					
				var listView = {
						path: "/view/test/blackbooksafe/list.html",
						position: { x: 0, y: 0 },
						getSearchBox: function() { return this.$("#searchBox"); }, 
						getList: function() { return this.$("#listPageBorder"); }
					}, 
					listPresenter = {
						about: function() { this.trigger("displayAbout"); },
						add: function() { this.trigger("addContact"); },  
						
						displayContacts: function(contacts) {
							this.view.getList()
								.modelList("option", "source", contacts)
								.modelList("display"); 
								
							if(this.id) {
								this.view.getList().modelList("find", {
									id: this.id
								});
							}
						}, 
						displayContact: function() { 
							this.view.getList().modelList("select");  
						},  
						updateContact: function(contact) { 
							this.view.getList().modelList("update", contact);
						}, 
						nextContact: function() { 
							var nextItem = this.view.getList().modelList("next");
							if(!nextItem) { return; }
							
							return nextItem.data("item.modelList");
						},
						prevContact: function() {  
							var prevItem = this.view.getList().modelList("prev");
							if(!prevItem) { return; }
							
							return prevItem.data("item.modelList");								
						},
						
						resetEscape: function() { this.escapeCount = 0; },  
						resetFilter: function() { this.view.getSearchBox().val(""); }, 
						getFilterQuery: function() { 
							var query = $.trim(this.view.getSearchBox().val()).replace(/ /g, "");
							return query.toLowerCase();
						}, 
						filter: function() {  
							var filterQuery = this.getFilterQuery();

							this.view.getList().modelList("filter", function(item) {
								var contact = item.data("item.modelList"),
									target = (contact.firstName + contact.lastName).replace(/ /g,"");
								target = target.toLowerCase();
								return (target.search(filterQuery) >= 0);
							});
							
							this.resetEscape();
						}, 
						
						go: function() {  
							var self = this;
							this.view.getList().modelList({
								
								template: function(item) { 
									return "<table><tr>" + 
									"<td><img id='img_" + item.id  + "' width=36 height=48 class='photoSmall' src='" + item.imagePath + "' /></td>" +
									"<td><span class='tableFieldName listValue'>" + item.firstName + " " + item.lastName + "</span><span class='tableFieldName listValue'>" + item.phone + "</span></td>" +
									"</tr></table>";
								},
								
								select: $.proxy(function(e, ui) { 
									this.trigger("displayContact", ui.item.data("item.modelList"));
								}, this)
							});
	
							function onSuccess(contacts) {  
								this.displayContacts(contacts);
							}
							function onError(ex) { }
							
							var filterQuery = this.getFilterQuery(),
							  	criteria = filterQuery.length <= 0 ? {} : { filter: filterQuery }; 
							this.contactService.get(criteria, $.proxy(onSuccess, this), $.proxy(onError, this)); 
						},
						events: { 
							keydown: {   
								def: function() { 
									this.view.getSearchBox().focus(); 
								},
								escape: function() {  
									if (!this.escapeCount) { this.resetEscape(); }
									this.escapeCount = this.escapeCount + 1;
									if(this.escapeCount < 2) { return; }
	
									this.resetFilter();
									this.filter(); 
								}, 
								enter: function(){ this.displayContact(); },
								down: function(){ this.nextContact(); }, 
								up: function(){ this.prevContact(); }
							}, 
							input: {
								"#searchBox" : function() { this.filter(); }
							},
							click: { 
								"#viewAbout_btn": function(){ this.about(); }, 
								"#add": function(){ this.add(); }, 
								"#minimize": function(){ this.minimize(); },
								"#close": function(){ this.exit(); }
							}
						}
					}, 
					listTransitions = { 
						detail: function() { 
							this.from.flip3d(false); 
							this.to.zoom(true, this.from.view.getList());
						}, 
						edit: function() {  
							this.from.flip3d(false);
	
							this.to.zoom(true, this.from.view.getList());
						}, 
						about: function() {
							this.to.ripple(true);
						}
					};
					
				var editView = {
						path: "/view/test/blackbooksafe/edit.html",
						position: { x: 120, y: 70 }, 
						getFirstName: function() { return this.$("#firstName"); },
						getLastName: function() { return this.$("#lastName"); },
						getPhone: function() { return this.$("#phone"); },
						getEmail: function() { return this.$("#email"); },
						getWebsite: function() { return this.$("#website"); },
						getBirthday: function() { return this.$("#birthday"); },
						getNotes: function() { return this.$("#notes"); },
						getPhoto: function() { return this.$("#photo"); }
					}, 
					editPresenter = {
						LOADING_IMAGE: "/asset/img/test/blackbooksafe/loader.gif", 
						
						setActiveContact: function(contact) {
							this.activeContact = contact;
							this.setForm(this.activeContact);
						}, 
						
						setForm: function(contact) {
							this.view.getFirstName().val(contact.firstName);
							this.view.getLastName().val(contact.lastName);
							this.view.getPhone().val(contact.phone);
							this.view.getEmail().val(contact.email);
							this.view.getWebsite().val(contact.website);
							this.view.getBirthday().val(contact.birthDate);
							this.view.getNotes().val(contact.notes); 
							this.view.getPhoto().attr("src", contact.imagePath);
						}, 
						readForm: function() { 
							var contact = this.activeContact;
	
							contact.firstName = this.view.getFirstName().val(); 
							contact.lastName = this.view.getLastName().val(); 
							contact.phone = this.view.getPhone().val();
							contact.email = this.view.getEmail().val();
							contact.website = this.view.getWebsite().val();
							contact.birthDate = this.view.getBirthday().val();
							contact.notes = this.view.getNotes().val();												

							var photoSrc = this.view.getPhoto().attr("src"); 
							contact.photo = !this.contactService.isDefaultImage(photoSrc) ? this.contactService.readImage(photoSrc) : null;
							
							return contact;
						}, 
						
						revertImage: function() {
							var contact = this.activeContact;
							
							if (contact.oldImagePath) {
								contact.imagePath = contact.oldImagePath;
								contact.smallImagePath = contact.oldSmallImagePath;
								delete contact.oldImagePath;
								delete contact.oldSmallImagePath;
								
								// update src to update image
								this.view.getPhoto().attr("src", contact.imagePath); 
							}
							// delete temporary (if exists)
							var tempFile = this.contactService.generateResizeTemp(contact);
							$.air.files.del(tempFile);
						}, 
						updateImage: function(imagePath) {
							var contact = this.activeContact;
							
							// on save, these oldPath needs to be deleted
							if (!this.contactService.isDefaultImage(contact.oldImagePath)) { 
								contact.oldImagePath = contact.imagePath;
								contact.oldSmallImagePath = contact.smallImagePath;
							}
							
							// update image paths 
							imagePath = imagePath + "?" + Math.random(); 
							
							// update src to load new image 
							this.view.getPhoto().attr("src", imagePath); 
						}, 
						readImageFiles: function(files) { 
							if(!files) { return; }

							var contact = this.activeContact;
							
							// even if we receive a list of files
							// we will stop to the first image file 
							var imageFile = this.contactService.generateResizeTemp(contact);
							$.each(files, $.proxy(function(i, file) { 
								file.canonicalize();
								// no folder
								if (file.isDirectory) return; 
								
								// allow only images
								var ext = file.extension; 
								if (ext.match(/png|jpg|gif|jpeg/i))
								{
									this.updateImage(this.LOADING_IMAGE);
									$.air.images.resize(file, imageFile, $.proxy(function(success, resizedFile) { 
										// if resize failed, bail out
										if (!success) {
											// revert image to original
											this.revertImage();
										} else {
											// update image src
											this.updateImage(resizedFile.url);
										}
									}, this));

									return false;
								}
							}, this)); 
						},						
						
						close: function() { 
							this.trigger("editContactCanceled", this.activeContact); 
						},
						submit: function() {
							//save contact
							var contact = this.readForm();

							function onSuccess(saved) {   
								this.trigger("contactUpdated", saved);
							}
							function onError(ex) { 
								alert("error saving contact"); 
							}
							this.contactService.save(contact, $.proxy(onSuccess, this), $.proxy(onError, this));
						}, 
						go: function() {   
							if(this.id) {
								//edit 
								function onSuccess(contact) { 
									this.setActiveContact(contact);
								}
								function onError(ex) { air.trace("error retrieving contact"); }
	
								this.contactService.get( { id: this.id }, $.proxy(onSuccess, this), $.proxy(onError, this) ); 
							} else { 
								//add  
								this.setActiveContact(this.contactService.create());
							} 

							this.view.getFirstName().focus();
						},
						events: {
							keydown: {
								escape: function() { this.close(); },
								enter: function() { this.submit(); },
								numpad_enter: function() { this.submit(); }
							}, 
							click: {
								"#closeedit" : function() { this.close(); }, 
								"#canceledit": function() { this.close(); },
								"#okedit": function() { this.submit(); }
							}, 
							
							//native event
							drop: { 
								"#photo_wrapper" : function(e) {  
									var files = e.originalEvent.dataTransfer.getData("application/x-vnd.adobe.air.file-list");
									this.readImageFiles(files);
								} 
							}
						}
					}, 
					editTransitions = {
						list: function() { 
							this.from.zoom(false, this.to.view.getList());
							this.to.flip3d(true);
						},
						detail: function() { 
							this.to.flipX(this.from, true); 
						}
					};
					
				var detailView = {
						path: "/view/test/blackbooksafe/detail.html",
						position: { x: 120, y: 70 }, 
						getFirstName: function() { return this.$("#firstName"); },
						getLastName: function() { return this.$("#lastName"); },
						getPhone: function() { return this.$("#phone"); },
						getEmail: function() { return this.$("#email"); },
						getWebsite: function() { return this.$("#website"); },
						getBirthday: function() { return this.$("#birthday"); },
						getNotes: function() { return this.$("#notes"); },
						getPhoto: function() { return this.$("#photo"); }
					}, 
					detailPresenter = {
						setActiveContact: function(contact) {
							this.activeContact = contact;
							
							if(!this.activeContact) return; 
							this.setForm(this.activeContact);
							
							
							this.trigger("contactDisplayed", $.extend({}, { ghost: true }, this.activeContact)); 
						}, 
						setForm: function(contact) {
							this.view.getFirstName().text(contact.firstName);
							this.view.getLastName().text(contact.lastName);
							this.view.getPhone().text(contact.phone);
							this.view.getEmail().text(contact.email);
							this.view.getWebsite().text(contact.website);
							this.view.getBirthday().text(contact.birthDate);
							this.view.getNotes().text(contact.notes); 
							this.view.getPhoto().attr("src", contact.imagePath);
						},
						close: function() {
							this.trigger("displayContactCanceled", this.activeContact);
						}, 
						prev: function() { 
							this.trigger("prevContact");
						}, 
						next: function() {
							this.trigger("nextContact");
						}, 
						edit: function() {   
							this.trigger("editContact", this.activeContact);
						}, 
						del: function() { 
							this.trigger("deleteContact", this.activeContact);
						}, 
						go: function() {  
							if(!this.id) return;

							if (this.deleted) {  
								function onDelSuccess(){  this.trigger("contactDeleted"); }
								function onDelError(ex){ this.trigger("contactDeleteFailed"); }
								
								this.contactService.del({ id: this.id }, $.proxy(onDelSuccess, this), $.proxy(onDelError, this));
							}
							else {
								function onGetSuccess(contact){ 
									this.setActiveContact(contact); 
								}
								function onGetError(ex) { }
								
								this.contactService.get({ id: this.id }, $.proxy(onGetSuccess, this), $.proxy(onGetError, this));
							} 
						},
						events: {
							keydown: {
								escape: function() { this.close(); },
								left: function() { this.prev(); },
								right: function() { this.next(); },
								up: function() { this.edit(); },
								down: function() { this.edit(); },
								del: function() { this.del(); }
							}, 
							click: {
								"#closedetails": function() { this.close(); }, 
								"#prevdetails": function() { this.prev(); },
								"#nextdetails": function() { this.next(); },
								"#backdetails": function() { this.close(); }, 
								"#editdetails": function() { this.edit(); }, 
								"#deletedetails": function() { this.del(); }
							}, 
						}
					}, 
					detailTransitions = { 
						list: function() {   
							//todo: move to presenter
							if (this.from.deleted) { 
								this.from.dissolve();
							} else {
								this.from.zoom(false, this.to.view.getList());
							}
						
							this.to.flip3d(true);
						},
						detail: function() {  
							if(this.from.preventTransition) { return; }
							
							this.from.flipY(this.to.reverse);
						}, 
						edit: function() {
							this.from.flipX(this.to, false); 
						},
						confirmDelete: function() { 
							this.to.bringToFront();
							this.to.show();
						}
					};
					
				var confirmDeleteView = {
						path: "/view/test/blackbooksafe/confirm-delete.html",
						position: { x: 120, y: 70 },
						getConfirmationText: function() { return this.$("#confirmText"); } 
					}, 
					confirmDeletePresenter = {
						setActiveContact: function(contact) {
							this.activeContact = contact;
							this.setForm();
						},
						setForm: function() { 
							this.view.getConfirmationText().html(this.getConfirmation());
						}, 
						getConfirmation: function() {
							var contact = this.activeContact, 
								contactName = contact.firstName + " " + contact.lastName;
							
							return  "Are you sure you want to remove " + contactName + " from your contact list?";
						}, 
						close: function() {
							this.trigger("confirmDeleteCanceled", { id: this.activeContact.id });
						},
						submit: function() {  
							this.trigger("deleteConfirmed", { id: this.activeContact.id }); 
						},
						go: function() { 
							function onSuccess(contact){  this.setActiveContact(contact); }
							function onError(ex) { } 
							
							this.contactService.get( { id: this.id }, $.proxy(onSuccess, this), $.proxy(onError, this));
						}, 
						events: {
							keydown: {
								escape: function() { this.close(); },
								enter: function() { this.submit(); },
								numpad_enter: function() { this.submit(); }
							}, 
							click: {
								"#cancelconfirm": function() { this.close(); },
								"#okconfirm": function() { this.submit(); }
							}
						} 
					}, 
					confirmDeleteTransitions = {
						detail: function() {
							this.from.dissolve();
						}
					};
					
					
				var aboutView = {
						path: "/view/test/blackbooksafe/about.html",
						position: { x: 91.5, y: 144 }
					},
					aboutPresenter = {
						//Methods
						close: function() { this.trigger("aboutCanceled"); },
						go: function() {
							//Overridde	
						}, 
						//Events
						events: {
							keydown: {
								escape: function(){ this.close(); },
								enter: function(){ this.close(); },
								numpad_enter: function(){ this.close(); }
							},
							click: {
								"#closeabout": function(){ this.close(); },
								"#okabout": function(){ this.close(); }
							}
						}
					},
					aboutTransitions = { 
						list: function(){ this.from.ripple(false); } 
					};		
	
				var authService = { 
						login: function(pwd, onSuccess, onFailure){ 
							this.db.open(pwd, onSuccess, onFailure);
						}
					},
					contactService = {
						getCacheKey: function(criteria) { 
							var cacheKey = "contacts:";
							
							criteria = criteria || {};
							if(criteria.id) {
								cacheKey += "id:" + criteria.id;
							}
							
							if(criteria.filter) {
								cacheKey += "filtered";
							}
							
							return cacheKey;
						}, 
						invalidateCache: function(criteria) {
							var cacheKey = this.getCacheKey(criteria); 
							delete this.cache[cacheKey];
						}, 
						
						create: function() {
							var contact = this.contactModel.build(); 
							this.setDefaultImagePath(contact);
							
							return contact;
						},  
						get: function(criteria, onSuccess, onFailure) { 
							
							var cacheKey = this.getCacheKey(criteria)
								cached = this.cache[cacheKey];
								
							if(cached) { 
								onSuccess(cached); 
							} else {
								function getSuccess(e, result) {
									if(!result) { return; }
									
									var data = result.data || [], 
										len = data.length,
										empty = (len <= 0),
										single = (len == 1);
										
									if(empty) { return; }
									
									data = single ? data[0] : data;
									
									this.cache[cacheKey] = data;
									
									if(single) { 
										this.setImagePath(data);
									} else {
										$.each(data, 
											$.proxy(function(i, item) { 
												this.setImagePath(item); 
											}, this)
										);
									}

									onSuccess(data); 
								}
								function getFailure(ex) { onFailure(ex); }
								
								this.db.tables("contact").get(criteria, $.proxy(getSuccess, this), $.proxy(getFailure, this));
							} 
						},
						save: function(contact, onSuccess, onFailure) {
							function saveSuccess(e, result) {  
								if (contact.id) {
									this.invalidateCache({
										id: contact.id
									});
								}
								this.invalidateCache({filter:"blank"});
								this.invalidateCache();

								if(result.lastInsertRowID) { contact.id = result.lastInsertRowID; }

								// move image from temp to final position
								// contact must have an id now 
								var finalFile = this.generateTemp(contact), imageFile = new air.File(contact.imagePath); 
								if (!this.isDefaultImage(imageFile.url) && imageFile.url != finalFile.url) {  
									try {
										imageFile.moveTo(finalFile, true);
									} catch(e) {}
								} 
								
								// update paths 
								contact.imagePath = finalFile.url;
								contact.smallImagePath = finalFile.url;
								// delete old paths
								if (contact.oldImagePath) {
									delete contact.oldImagePath;
									delete contact.oldSmallImagePath;
								}	 
								
								onSuccess(contact);
							}
							function saveFailure(ex) { onFailure(ex); } 

							this.db.tables("contact").set(contact, $.proxy(saveSuccess, this), $.proxy(saveFailure, this));
						},
						del: function(criteria, onSuccess, onFailure) {
							function delSuccess() {
								this.invalidateCache(criteria);
								this.invalidateCache({filter:"blank"});
								this.invalidateCache();
								
								onSuccess();
							}
							function delFailure(ex) { onFailure(ex); }
							
							this.db.tables("contact").del(criteria, $.proxy(delSuccess, this), $.proxy(delFailure, this)); 
						}, 
						
						setDefaultImagePath: function(contact) {
							contact.imagePath = "/asset/img/test/blackbooksafe/image_unavailable.png";
							contact.smallImagePath = "/asset/img/test/blackbooksafe/image_unavailable_small.png";
						}, 
						setImagePath: function(contact) {
							this.setDefaultImagePath(contact);
							
							if(!contact.photo) { return; } 
							var imageFile = $.air.files.temp(contact.id);
							$.air.files.write(imageFile, contact.photo);
							
							var imagePath =  imageFile.url + "?" + Math.random();
							contact.imagePath = imagePath;
							contact.smallImagePath = imagePath;
						}, 

						isDefaultImage: function(imageSrc) {
							return imageSrc && /image_unavailable.png/.test(imageSrc);
						},
						
						getImageDir: function() { 
							return air.File.applicationStorageDirectory.resolvePath("images/");
						},
						
						generateTemp: function(contact) { 
							contact = contact || {};
							
							var imageDir = this.getImageDir(),
								imagePath = contact.id ? 
									imageDir.resolvePath(contact.id) :
									imageDir.resolvePath("$temp$");

							return imagePath;
						},
						generateResizeTemp: function(contact) {  
							contact = contact || {};
							
							var imageDir = this.getImageDir(),
								imagePath = contact.id ? 
									imageDir.resolvePath("resize_" +contact.id) :
									imageDir.resolvePath("resize_temp");

							return imagePath;
						}, 
						
						readImage: function(imageSrc) { 
							return $.air.files.read(new air.File(imageSrc));
						}
					};
	
				var shell = { 
					//Presenter dependency methods
					getAuthDependencies: function() { 
						return { 
							authService: this.services("auth", { 
								db: this.db 
							}) 
						}; 
					},
					getContactDependencies: function(args) {  
						return $.extend({}, {  
							contactService: this.services("contact", { 
								contactModel: this.models("contact"), 
								cache: this.cache, 
								db: this.db 
							}), 
						}, args || {}); 
					}, 
					
					//Presenter methods
					//Map 1:1 with view keys
					login: function() { 
						this.present("login", this.getAuthDependencies()); 
					}, 
					newUser: function() {
						this.present("newUser", this.getAuthDependencies()); 
					}, 
					about: function() { 
						this.present("about"); 
					},
					list: function(args) {  
						this.present("list", this.getContactDependencies(args)); 
					},
					detail: function(args) {     
						this.present("detail", this.getContactDependencies(args)); 
					},
					edit: function(args) {    
						this.present("edit", this.getContactDependencies(args)); 
					},
					confirmDelete: function(args) { 
						this.present("confirmDelete", this.getContactDependencies(args)); 
					}, 
					
					//Active presenter methods 
					update: function(args) { 
						this.active("list").updateContact(args);
					}, 
					prev: function() {  
						var prevContact = this.active("list").prevContact();
						if(!prevContact) { 
							this.active("detail").shake(); 
							return;
						}
						
						var args = $.extend({}, { reverse: true }, prevContact);
						this.detail(args);
					}, 
					next: function() { 
						var nextContact = this.active("list").nextContact();
						if(!nextContact) { 
							this.active("detail").shake();
							return; 
						}
						
						var args = $.extend({}, { reverse: false }, nextContact);
						this.detail(args); 
					}, 

					//Overridden
					go: function() {   
						this.cache = { }; 
						this.db = new $.air.database("bbs-03", { 
							tables: { 
								"contact" : this.models("contact").toTable() 
							} 
						}); 
	
						if (this.db.isInitialized()) {  
							this.login();
						}
						else { 
							this.newUser();
						}
					}, 
					
					events: { 
						//login & newuser events
						loggedIn: function() { this.list(); }, //login => list 
						
						userCreated: function() { this.list(); }, //new user => list 
						
						//list events
						displayAbout: function(args) { this.about(); }, //list => about
						displayContact: function(args) { this.detail(args); }, //list => detail
						addContact: function(args) { this.edit(); }, //list => add
						
						//edit events
						contactUpdated: function(args) { this.update(args); this.detail(args); }, //edit => detail
						editContactCanceled: function(args) { if(args && args.id) { this.detail(args); } else { this.list(); } }, //edit => detail/list
						
						//detail events
						contactDisplayed: function(args) { this.update(args); }, 
						displayContactCanceled: function(args) { this.list(args); }, //detail => list
						prevContact: function(args) { this.prev(); }, //detail => detail (prev)
						nextContact: function(args) { this.next(); }, //detail => detail (next)
						editContact: function(args) { this.edit(args); }, //detail => edit
						deleteContact: function(args) { this.confirmDelete(args); }, //detail => confirm delete
						contactDeleted: function(args) {   //detail => list
							var contact = this.active("list").nextContact() || this.active("list").prevContact || {};
							this.list(contact); 
						},
						
						//confirm delete events
						deleteConfirmed: function(args) { this.detail( $.extend({}, { deleted: true }, args || {} )); }, //confirm delete => detail (contact deleted)
						confirmDeleteCanceled: function(args) { this.detail(args); }, //confirm delete => detail 
						
						//about events
						aboutCanceled: function(args) { this.list(args); } //about => list
					}
				};

				$.air.mvp({ 
					models: {
						contact: contactModel
					},
					views: {
						login: loginView,
						newUser: newUserView,
						list: listView,
						edit: editView,
						detail: detailView,
						confirmDelete: confirmDeleteView,
						about: aboutView
					},
					presenters: {
						login: loginPresenter,
						newUser: newUserPresenter,
						list: listPresenter,
						edit: editPresenter,
						detail: detailPresenter,
						confirmDelete: confirmDeletePresenter,
						about: aboutPresenter
					},
					transitions: {
						login: loginTransitions,
						newUser: newUserTransitions,
						list: listTransitions,
						edit: editTransitions,
						detail: detailTransitions,
						confirmDelete: confirmDeleteTransitions,
						about: aboutTransitions
					},
					services: {
						auth: authService,
						contact: contactService
					},
					shell: shell
				});
			}); 
		</script>
    </body>
</html>
